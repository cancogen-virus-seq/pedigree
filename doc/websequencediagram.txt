# generated using https://www.websequencediagrams.com/

title Pedigree Sequence Diagram

actor Scheduler
alt 

    Scheduler->Pedigree: PROFILE=updateCache
    Pedigree->+Song: GET /studies/all
    Song-->-Pedigree: return List of StudyIDs
    loop each StudyID
        loop each Pagination
            Pedigree->+Song: GET /studies/{studyId}/analysis/paginated \n100 analysis PUBLISHED
            Song-->-Pedigree: return List of Analysis
        
            Pedigree->Cache: save AnalysisID, specimen_collector_sample_ID, lineage data
        end loop
    end
    Pedigree->Scheduler: Finish
    
    
else 

    Scheduler->Pedigree: PROFILE=updateLineage
    
    Pedigree->+ViralAI: download .tsv from bucket
    
    loop each Analysis from .tsv
        Pedigree->+Cache: get AnalysisID by specimen_collector_sample_ID
        Cache-->-Pedigree: return AnalysisID
        
        
        alt IF schema version 16 & linage has changed
        
            Pedigree->Song: PATCH /studies/{studyId}/analysis/{analysisId}
            
        end
        
    end
    
    ViralAI-->-Pedigree: finish reading .tsv
    
    Pedigree->Scheduler: Finish
    
else 
    
    Scheduler->Pedigree: no profile/default
    
    # Without a profile it should behave as joining the logic 
    # of the 2 previous profiles (updateCache + updateLinage) sequentially
    
    Pedigree->+Song: GET /studies/all
    Song-->-Pedigree: return List of StudyIDs
    loop each StudyID
        loop each Pagination
            Pedigree->+Song: GET /studies/{studyId}/analysis/paginated \n100 analysis PUBLISHED
            Song-->-Pedigree: return List of Analysis
        
            Pedigree->Cache: save AnalysisID, specimen_collector_sample_ID, lineage data
        end loop
    end
    
    
    Pedigree->+ViralAI: download .tsv from bucket
    
    loop each Analysis from .tsv
        Pedigree->+Cache: get AnalysisID by specimen_collector_sample_ID
        Cache-->-Pedigree: return AnalysisID
        
        
        alt IF schema version 16 & linage has changed
        
            Pedigree->Song: PATCH /studies/{studyId}/analysis/{analysisId}
            
        end
        
    end
    
    ViralAI-->-Pedigree: finish reading .tsv
    
    Pedigree->Scheduler: Finish
    
end
